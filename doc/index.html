<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<title>Walkthrough</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="article">
<div id="header">
<h1>Walkthrough</h1>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>clj-salt-api is data oriented Clojure library for interacting with Saltstack through <a href="http://docs.saltstack.com/en/latest/ref/netapi/all/salt.netapi.rest_cherrypy.html#module-salt.netapi.rest_cherrypy.app">salt-api</a></p>
</div>
<div class="paragraph">
<p>The aim of this document is to provide motivation, decisions, code samples and caveats behind clj-salt-api. This is my first Clojure project, so I have created this document for me as a developer to understand (and remember) decisions with their benefits and drawbacks, but it can serve as documentation for everyone interested in this library.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_clojure_and_saltstack"><a class="anchor" href="#_clojure_and_saltstack"></a><a class="link" href="#_clojure_and_saltstack">Clojure and Saltstack</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://docs.saltstack.com">Saltstack</a> is a configuration management and orchestration tool with solid remote execution framework. Salt is written in Python and leverages <a href="https://zeromq.org/">ZeroMQ messaging library</a>, which allows users to run tasks simultaneously with satisfying performance.</p>
</div>
<div class="paragraph">
<p>Saltstack architecture is very flexible, it provides master-client (master-minion), master-less or ssh slaves setup. There are basically three options to interact with Salt master:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>CLI on master node</p>
</li>
<li>
<p>Python API on master node</p>
</li>
<li>
<p><a href="https://docs.saltstack.com/en/latest/ref/cli/salt-api.html">HTTP API</a> to run commands remotely - used by clj-salt-api</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Saltstack provides plethora of modules running on almost all operating systems.</p>
</div>
<hr>
<div class="paragraph">
<p><a href="https://clojure.org/">Clojure</a> is well known programming language. Although the main reason why I have chosen Clojure is Clojure itself ;), it has several interesting properties that suite this project well.</p>
</div>
<div class="paragraph">
<p>With Clojure dynamic nature and very good data structures, clj-salt-api supports almost all Salt modules. clj-salt-api sends requests to Salt as data (Clojure maps) and returns data back. This approach is heavily inspired by <a href="https://github.com/cognitect-labs/aws-api">aws-api</a>. It makes API very simple and there are no differences to Saltstack API. Therefore user of clj-salt-api can benefit from <a href="https://docs.saltstack.com/en/latest/">Saltstack official documentation</a> and this library has minimal compatibility issues with different Saltstack versions.</p>
</div>
<div class="paragraph">
<p>Salstack provides both synchronous and asynchronous API. clj-salt-api aims to support both approaches and Clojure asynchronous/multi-threading solutions can ensure clean design.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_motivation"><a class="anchor" href="#_motivation"></a><a class="link" href="#_motivation">Motivation</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are basically two reasons behind this project:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>There is no client Saltstack client library in Clojure</p>
</li>
<li>
<p>Proper handling of salt-api asynchronous workflow requires fair amount of work - clj-salt-api hides this workflow and provides simple API for its users</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_saltstack_asynchronous_workflow"><a class="anchor" href="#_saltstack_asynchronous_workflow"></a><a class="link" href="#_saltstack_asynchronous_workflow">Saltstack asynchronous workflow</a></h3>
<div class="paragraph">
<p>Implementation of salt-api asynchronous requests relies on <a href="https://docs.saltstack.com/en/master/topics/event/events.html">event system</a> and <a href="https://docs.saltstack.com/en/getstarted/event/index.html">event-driven infrastructure</a>. Salt&#8217;s internal components communicate with each other by sending and listening to events. Each command has dedicated job with unique <em>job-id</em>. "Job sents" and "job returns" are represented as events on saltstack event-bus.</p>
</div>
<div class="paragraph">
<p>Salt-api <code>/events</code> endpoint exposes Salt event-bus as HTTP stream formatted per the <a href="https://html.spec.whatwg.org/multipage/server-sent-events.html">Server Sent Events (SSE) spec</a>. Each event is formatted as JSON.</p>
</div>
<div class="paragraph">
<p>Simplified asynchronous request flow (as described <a href="https://docs.saltstack.com/en/latest/ref/netapi/all/salt.netapi.rest_cherrypy.html#long-running-http-connections">here</a>):</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Connect to <code>/events</code> endpoint and buffer all events.</p>
</li>
<li>
<p>Send HTTP request with async client (<a href="https://docs.saltstack.com/en/latest/topics/netapi/index.html#salt.netapi.NetapiClient.local_async">local_async</a>, <a href="https://docs.saltstack.com/en/latest/topics/netapi/index.html#salt.netapi.NetapiClient.runner_async">runner_async</a> or <a href="https://docs.saltstack.com/en/latest/topics/netapi/index.html#salt.netapi.NetapiClient.wheel_async">wheel_async</a>) and receive <em>job-id</em> and target minions (if appropriate) in response. Runner and wheel clients run on master, so there is no reason to parse target minions.</p>
</li>
<li>
<p>Filter events buffer for "job return" events with expected <em>job-id</em> and <em>minion-id</em> and deliver response to caller.</p>
</li>
<li>
<p>Listen to remaining (expected) "job return" events with expected <em>job-id</em> and deliver minion response to caller.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Things to consider:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>One or more target minions have not sent "job return" event within specified timeout</p>
<div class="ulist">
<ul>
<li>
<p>Execute <a href="https://docs.saltstack.com/en/latest/ref/modules/all/salt.modules.saltutil.html#salt.modules.saltutil.find_job">saltutil.find_job</a> function on timed out minions to check the job result.</p>
</li>
<li>
<p>If <a href="https://docs.saltstack.com/en/latest/ref/modules/all/salt.modules.saltutil.html#salt.modules.saltutil.find_job">saltutil.find_job</a> returns an error, deliver error response for all timed out minions.</p>
</li>
<li>
<p>If <a href="https://docs.saltstack.com/en/latest/ref/modules/all/salt.modules.saltutil.html#salt.modules.saltutil.find_job">saltutil.find_job</a> returns successfully, but response contains minion failures, deliver error response for failed minions and continue processing "job return events" until all expected minions return.</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>/events</code> endpoint has been closed during asynchronous request</p>
<div class="ulist">
<ul>
<li>
<p>If it is not possible to reconnect within specified backoff strategy, deliver error and close async request.</p>
</li>
<li>
<p>If connection to <code>/events</code> endpoint has been successfully reopened, fetch "job returns" with <a href="https://docs.saltstack.com/en/latest/ref/runners/all/salt.runners.jobs.html#salt.runners.jobs.print_job">jobs.print_job</a> function. Deliver responses for already finished minions and continue processing of "job return events" until all expected minions return.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Saltstack does not send <a href="https://html.spec.whatwg.org/multipage/server-sent-events.html#event-stream-interpretation"><code>Last-Event-ID</code></a> header when reconnecting to <code>/events</code>, so client has to fetch job results with runner job module.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_other_features"><a class="anchor" href="#_other_features"></a><a class="link" href="#_other_features">Other features</a></h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<tbody>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Authentication</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Saltstack requires user to authenticate. clj-salt-api authenticates user, handles token expiration and automatic re-authentication under the hood.</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Synchronous requests</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Besides support for asynchronous workflow, clj-salt-api also enables synchronous requests</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Tread-safety when executing parallel requests</p></th>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>clj-salt-api allows to execute multiple requests (async or sync) in parallel with only one connection to <code>/events</code> endpoint. This connection can be set up in two modes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Keep HTTP connection opened even there is no asynchronous request running.</p>
</li>
<li>
<p>clj-salt-api ensures there is only one connection opened, but it will closed, if it is not needed any more (no async request running) and opened if its needed (not connected and async request started).</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Stream of all events</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">clj-salt-api provides an API for listening to all events on Saltstack event-bus.</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Graceful shutdown</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">It is common, that Salt commands could take several minutes (e.g. package management commands). So there is need to shutdown client and correctly cancel running requests.</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">HTTP support</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">clj-salt-api relies on HTTP when communicating with Saltstack. It needs to support various HTTP features (Authentication, Proxy, Custom Headers, &#8230;&#8203;)</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Retries with backoff policies</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">clj-salt-api executes number of remote calls and as we all know network can be unreliable.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_basic_architecture"><a class="anchor" href="#_basic_architecture"></a><a class="link" href="#_basic_architecture">Basic architecture</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Simplified sketch of asynchronous flow design:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="clj-salt-api.svg" alt="clj salt api">
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Sse (go block) is started during <a href="../src/salt/client.clj">client initialization</a>. It listens to subscriptions with <code>subs-chan</code> and sends sse events or subscription responses to <code>sse-resp-chan</code> with attached <a href="https://clojuredocs.org/clojure.core.async/mult">mult</a>.</p>
</li>
<li>
<p>For each async request clj-salt-api creates a <code>recv-chan</code> and starts a new go block which delivers responses to <code>async-resp-chan</code>.</p>
</li>
<li>
<p>Async request (go block) subscribes to sse events by sending subscription to <code>subs-chan</code> with unique <code>correlation-id</code>.</p>
</li>
<li>
<p>After sse receives subscription with <code>correlation-id</code> through <code>subs-chan</code>, it copies <code>sse-resp-chan</code> (with <a href="https://clojuredocs.org/clojure.core.async/tap">tap</a>) to <code>recv-chan</code> and makes sure its connected to <code>/events</code> endpoint. The state of <code>/events</code> connection depends on keep-alive setting.</p>
</li>
<li>
<p>Only after sse is connected to <code>/events</code>, it sends the subscription response with corresponding <code>correlation-id</code> back to <code>sse-resp-chan</code>.</p>
</li>
<li>
<p>When async request receives the subscription response, it submits its job (module function call) to saltstack and receives <code>job-id</code> and target minions back (if appropriate).</p>
</li>
<li>
<p>Async request waits for responses of all target minions, delivers them to <code>async-resp-chan</code> as they come and closes the <code>async-resp-chan</code>.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
clj-salt-api implements similar flow for <em>all events stream</em>.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_error_handling"><a class="anchor" href="#_error_handling"></a><a class="link" href="#_error_handling">Error handling</a></h3>
<div class="paragraph">
<p>There are basically 3 types of errors:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>minion error</p>
<div class="ulist">
<ul>
<li>
<p>async request just delivers minion error to caller</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>/events</code> error</p>
<div class="ulist">
<ul>
<li>
<p>sse tries to reconnect to <code>/events</code> endpoint</p>
</li>
<li>
<p>if reconnection is successful,</p>
<div class="ulist">
<ul>
<li>
<p>sse sends reconnected message to <code>sse-resp-chan</code></p>
</li>
<li>
<p>all running async requests have to fetch job result with <a href="https://docs.saltstack.com/en/latest/ref/runners/all/salt.runners.jobs.html#salt.runners.jobs.print_job">jobs.print_job</a>, because job can be already finished and "job return" event has been missed (saltstack does not support <code>Last-Event-ID</code> concept)</p>
</li>
<li>
<p>all running async requests deliver already finished jobs and continue consuming <code>recv-chans</code> until all expected minion responses are delivered</p>
</li>
</ul>
</div>
</li>
<li>
<p>if reconnection is not successful, all running async requests deliver error and close respective `async-resp-chan`s</p>
</li>
</ul>
</div>
</li>
<li>
<p>minion timed out ("job return" event has not been delivered within specified time)</p>
<div class="ulist">
<ul>
<li>
<p>async request executes <a href="https://docs.saltstack.com/en/latest/ref/modules/all/salt.modules.saltutil.html#salt.modules.saltutil.find_job">saltutil.find_job</a> to check job status</p>
</li>
<li>
<p>if <code>saltutil.find_job</code> fails, async request delivers error and close respective <code>async-resp-chan</code></p>
</li>
<li>
<p>if <code>saltutil.find_job</code> succeeds, async request deliver only failed minions and waits for events from remaining with <code>recv-chan</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_state_handling"><a class="anchor" href="#_state_handling"></a><a class="link" href="#_state_handling">State handling</a></h3>
<div class="paragraph">
<p>clj-salt-api has to manage 2 types of state.</p>
</div>
<div class="paragraph">
<p>The first one is simple. Its client related information like salt master settings, salt token, <code>subs-chan</code> etc. clj-salt-api uses atom (referred as <code>client-atom</code> in code) to hold this information.</p>
</div>
<div class="paragraph">
<p>The second one is trickier. clj-salt-api has a state associated with go blocks (sse, async request, all events stream and sync request). All go blocks implement solution similar to the one mentioned in <a href="https://clojuredesign.club/episode/026-one-call-to-rule-them-all/">clojuredesign.club episode 026</a>. I highly recommend clojuredesign.club podcast and want to thank Chris and Nate for sharing a lot of their knowledge.</p>
</div>
<div class="paragraph">
<p>Each go block is a loop with state (a map named <code>op</code>) and two steps. The state (<code>op</code>) consists of current command and various data (correlation-id, list of target minions, minion timeout, number of retries, &#8230;&#8203;) specific to go block. The steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>execute-command</code> - call async function (reading/writing to channel) and returns channel message as response</p>
</li>
<li>
<p><code>handle-response</code> - pure function that accepts current state (<code>op</code>) and command response as parameters and returns new state (<code>op</code>). Go block loop stops when there is no new state returned from <code>handle-response</code>.</p>
</li>
</ol>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="goblock.svg" alt="goblock">
</div>
</div>
<div id="async-code" class="paragraph">
<p>Sample code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">defn</span> <span class="function">handle-response</span>
  [{<span class="symbol">:keys</span> [<span class="symbol">:command</span>] <span class="symbol">:as</span> op} response]
  (<span class="keyword">try</span>
    (<span class="keyword">case</span> command
      <span class="symbol">:subscribe</span> (handle-with-command op <span class="symbol">:connect</span>)
      <span class="symbol">:connect</span> (handle-connect op response)
      <span class="symbol">:request</span> (handle-request op response)
      <span class="symbol">:receive</span> (handle-receive op response)
      <span class="symbol">:send</span> (handle-send op)
      <span class="symbol">:reconnect</span> (handle-reconnect op response)
      <span class="symbol">:find-job</span> (handle-find-job op response)
      <span class="symbol">:error</span> (unsubscribe op)
      <span class="symbol">:unsubscribe</span> (handle-unsubscribe op response)
      <span class="symbol">:exit</span> <span class="predefined-constant">nil</span>)
    (<span class="keyword">catch</span> Throwable e
      (<span class="keyword">assoc</span> op <span class="symbol">:command</span> <span class="symbol">:error</span> <span class="symbol">:body</span> e))))

(<span class="keyword">defn</span> <span class="function">request-async</span>
  [client-atom req async-resp-chan recv-buffer-size]
  (<span class="keyword">let</span> [correlation-id (java.util.UUID/randomUUID)
        client @client-atom
        subs-chan (<span class="symbol">:sse-subs-chan</span> client)
        recv-chan (<span class="keyword">if</span> (<span class="keyword">&lt;</span> <span class="integer">1</span> recv-buffer-size) (a/chan) (a/chan recv-buffer-size))]
    (a/go
      (<span class="keyword">loop</span> [{<span class="symbol">:keys</span> [<span class="symbol">:command</span> <span class="symbol">:body</span> <span class="symbol">:last-receive-time</span> <span class="symbol">:minion-timeout</span>] <span class="symbol">:as</span> op}
             (initial-op req correlation-id recv-chan)]
        (<span class="keyword">when</span> command
          (<span class="keyword">-&gt;&gt;</span>
           (<span class="keyword">case</span> command
             <span class="symbol">:subscribe</span> (a/&gt;! subs-chan body)
             <span class="symbol">:connect</span> (a/&lt;! recv-chan)
             <span class="symbol">:request</span> (a/&lt;! (req/request client-atom body (a/chan)))
             <span class="symbol">:receive</span> (<span class="keyword">let</span> [timeout-chan (a/timeout
                                          (find-job-timeout minion-timeout
                                                            last-receive-time))]
                        (a/alt!
                          timeout-chan [<span class="symbol">:timeout</span>]
                          recv-chan ([result] [<span class="symbol">:receive</span> result])))
             <span class="symbol">:reconnect</span> (a/&lt;! (req/request client-atom body (a/chan)))
             <span class="symbol">:find-job</span> (a/&lt;! (req/request client-atom body (a/chan)))
             <span class="symbol">:send</span> (<span class="keyword">doseq</span> [b (to-vec body)]
                     (a/&gt;! async-resp-chan b))
             <span class="symbol">:error</span> (a/&gt;! async-resp-chan body)
             <span class="symbol">:unsubscribe</span> (a/alt!
                            [[subs-chan body]] [<span class="symbol">:unsubscribe</span>]
                            recv-chan ([msg] [<span class="symbol">:receive</span> msg])
                            <span class="symbol">:priority</span> <span class="predefined-constant">true</span>)
             <span class="symbol">:exit</span> (graceful-shutdown recv-chan async-resp-chan))
           (handle-response op)
           (<span class="keyword">recur</span>)))))
    async-resp-chan))</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This solution is just a simplified state machine. I have been thinking in splitting it in multiple <a href="http://250bpm.com/blog:69">state machines</a>, but I still find it as a readable code, so I have left it as it is.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_caveats"><a class="anchor" href="#_caveats"></a><a class="link" href="#_caveats">Caveats</a></h3>
<div class="paragraph">
<p>Implementing async flows with core.async has been relatively easy task, nevertheless I have ran into two serious problems I&#8217;d like to share. I recommend to set buffers length to 0 for all core.async channels to detect similar problems.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It would be very helpful to have an option to monitor channels (e.g. list all core.async channels and their buffer capacity in runtime), but I have not found any.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_deadlock_n_1"><a class="anchor" href="#_deadlock_n_1"></a><a class="link" href="#_deadlock_n_1">Deadlock n. 1</a></h4>
<div class="paragraph">
<p>This type of deadlock is described in <a href="https://medium.com/@elizarov/deadlocks-in-non-hierarchical-csp-e5910d137cc">this article</a> by Roman Elizarov.</p>
</div>
<div class="paragraph">
<p>The deadlock happens when sse tries to deliver an event with <code>sse-resp-chan</code> and async request tries to unsubscribe. Sse is blocked on sending event to <code>sse-resp-chan</code> and does not read <code>subs-chan</code> and async request is blocked on sending unsubscribe message to <code>subs-chan</code> and does not read <code>recv-chan</code> (copy of <code>sse-resp-chan</code>).</p>
</div>
<div class="paragraph">
<p>To overcome this problem clj-salt-api uses <a href="https://clojuredocs.org/clojure.core.async/alt!">alt!</a> when reading/writing to pair of pub/sub channels.</p>
</div>
</div>
<div class="sect3">
<h4 id="_deadlock_n_2"><a class="anchor" href="#_deadlock_n_2"></a><a class="link" href="#_deadlock_n_2">Deadlock n. 2</a></h4>
<div class="paragraph">
<p>Deadlock n.2 is not so obvious as n.1 and took me some time to find the root cause. It is better explained through example. For the purpose of example, lets assume user of clj-salt-api library executes async request <code>pkg.installed</code>, but sse is reconnected during this request. As described earlier, after sse reconnection async request (<code>pkg.installed</code>) has to fetch job status with <a href="https://docs.saltstack.com/en/latest/ref/runners/all/salt.runners.jobs.html#salt.runners.jobs.print_job">jobs.print_job</a>. What happens in this scenario?</p>
</div>
<div class="ulist">
<ul>
<li>
<p>We have two running async requests (<code>pkg.installed</code> and <code>job.print_job</code>) with two different <code>recv-chans</code> tapped from <code>sse-resp-chan</code> mult.</p>
</li>
<li>
<p><code>pkg.installed</code> has created new <code>async-resp-chan</code> for <code>job.print_job</code> and is parked in take from this chan (it is waiting for response from print_job)</p>
</li>
<li>
<p><code>job.print_job</code> has been successfully subscribed to sse and has submitted job to saltstack</p>
</li>
<li>
<p>"job sent" event is sent back from saltstack to <code>/events</code> endpoint and is delivered from HTTP client to sse go block</p>
</li>
<li>
<p>sse puts "job sent" event to <code>sse-resp-chan</code></p>
</li>
<li>
<p>event is distributed to all taps in parallel an synchronously, which means it is put to <code>pkg.installed recv-chan</code> and <code>job.print_job recv-chan</code></p>
</li>
<li>
<p><code>job.print_job</code> takes "job sent" event and continue waiting for "job return" event (park in take from <code>recv-chan</code>)</p>
</li>
<li>
<p><code>pkg.installed</code> is parked in taking response from <code>jobs.print_job</code> and does not take "job sent" event</p>
</li>
<li>
<p>sse is deadlock in putting "job sent" event to <code>sse-resp-chan</code> mult, because <code>pkg.installed</code> has not taken value and its buffer length is 0. clj-salt-api uses non zero length buffer on <code>recv-chan</code> in release version, but to detect deadlocks, it uses channels without buffers</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_setting_buffer_size"><a class="anchor" href="#_setting_buffer_size"></a><a class="link" href="#_setting_buffer_size">Setting buffer size</a></h4>
<div class="paragraph">
<p>One interesting topic I&#8217;d like to mention is how to set correct buffer sizes in core.async channels. General recommendation mentioned in core.async documentation is to set buffer size for slow consumers not to block quick consumers. Let&#8217;s examine our channels:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 50%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Channel</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Data</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Buffer size</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sse-chan</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">consumer (sse go block) could be parked in sending data to async request, which could be parked taking from in find_job or print_job</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">buffer needed</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>subs-chan</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">consumer (sse go block) could be parked, but async request has to wait for subscription response, so it could be blocked in putting message to <code>subs-chan</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no buffer needed</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sse-resp-chan</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">mult exists on top of this channel</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no buffer needed</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>recv-chan</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">one consumer (async request) could be parked in taking from find_job or print_job</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">buffer needed</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>async-resp-chan</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">consumer is outside of clj-salt-client, so it will be better to pass the channel as a parameter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">not applicable</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_code_conventions"><a class="anchor" href="#_code_conventions"></a><a class="link" href="#_code_conventions">Code conventions</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>I have struggled with code readability at first. All functions looked similar and I had problems to understand function body after some time passed.</p>
</div>
<div class="paragraph">
<p>To overcome this problem, I have found three helpful conventions:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#_destructuring_function_arguments">Destructuring function arguments</a></p>
</li>
<li>
<p><a href="#_small_functions">Small functions</a></p>
</li>
<li>
<p><a href="#_comments">Comments</a></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Another technique I have found useful <a href="#_passing_data_down">Passing data down</a> (maybe there is a better name in Clojure community, which I am not aware of).</p>
</div>
<div class="sect2">
<h3 id="_destructuring_function_arguments"><a class="anchor" href="#_destructuring_function_arguments"></a><a class="link" href="#_destructuring_function_arguments">Destructuring function arguments</a></h3>
<div class="paragraph">
<p>Whenever possible clj-salt-api uses destructuring. This technique helps me to understand the data passed to function, just looking at a function name and parameters.</p>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">  [{<span class="symbol">:keys</span> [<span class="symbol">:subscription-count</span>] <span class="symbol">:as</span> op}
   {<span class="symbol">:keys</span> [<span class="symbol">:type</span> <span class="symbol">:data</span> <span class="symbol">:retry</span>] <span class="symbol">:as</span> event}]
  (<span class="keyword">if</span> (<span class="keyword">instance?</span> Throwable event)       <span class="comment">; SSE sent an error</span>
    (<span class="keyword">assoc</span> op <span class="symbol">:command</span> <span class="symbol">:send</span> <span class="symbol">:body</span> event)
    (<span class="keyword">if</span> (<span class="keyword">nil?</span> <span class="keyword">type</span>)                     <span class="comment">; SSE has been closed</span>
      (<span class="keyword">assoc</span> op <span class="symbol">:command</span> <span class="symbol">:close</span>)
      (<span class="keyword">if</span> (<span class="keyword">=</span> <span class="integer">0</span> subscription-count)
        (<span class="keyword">assoc</span> op <span class="symbol">:command</span> <span class="symbol">:receive</span>)    <span class="comment">; ignore event if there is no subscriber</span>
        (<span class="keyword">case</span> <span class="keyword">type</span>
          <span class="symbol">:data</span> (<span class="keyword">assoc</span> op <span class="symbol">:command</span> <span class="symbol">:send</span> <span class="symbol">:body</span> data)
          <span class="symbol">:retry</span> (<span class="keyword">assoc</span> op <span class="symbol">:command</span> <span class="symbol">:receive</span> <span class="symbol">:retry-timeout</span> retry)
          <span class="symbol">:close</span> (<span class="keyword">assoc</span> op <span class="symbol">:command</span> <span class="symbol">:receive</span>))))))</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_small_functions"><a class="anchor" href="#_small_functions"></a><a class="link" href="#_small_functions">Small functions</a></h3>
<div class="paragraph">
<p>Clojure is very consistent and concise language. Often a function is one block (threading macro/go-block/if/case&#8230;&#8203;) with several calls of map/filter/assoc/update/&#8230;&#8203;. I understand the pros, but having functions all build up from core libraries, made my code less readable. So every time I have written a function body that I have not understand at the first look, I have tried to extract functions with names easy to read (even if extracted functions are one-liners and used only once).</p>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">defn-</span> <span class="function">not-comment-line?</span>
  [field]
  (<span class="keyword">not</span><span class="keyword">=</span> '<span class="error">:</span>' (<span class="keyword">first</span> field)))

(<span class="keyword">defn-</span> <span class="function">retry-field?</span>
  [field]
  (<span class="keyword">=</span> <span class="symbol">:retry</span> (<span class="keyword">first</span> field)))

(<span class="keyword">defn</span> <span class="function">sse-buffer-&gt;events</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Converts sse buffer to collection of events and next buffer value</span><span class="delimiter">&quot;</span></span>
  [buf prev-buf]
  (<span class="keyword">let</span> [[chunks next-buf] (split-buffer (<span class="keyword">str</span> prev-buf buf))]
    [(<span class="keyword">-&gt;&gt;</span> chunks
          (<span class="keyword">mapcat</span> (<span class="keyword">fn</span> [chunk]
                    (<span class="keyword">-&gt;&gt;</span> chunk
                         (str/split-lines)
                         (<span class="keyword">filter</span> not-comment-line?)
                         (<span class="keyword">map</span> line-&gt;field)
                         (<span class="keyword">filter</span> sse-supported-field?)
                         (group-by retry-field?)
                         (<span class="keyword">map</span> (<span class="keyword">fn</span> [group]
                                (<span class="keyword">let</span> [[retry? fields] group]
                                  (<span class="keyword">if</span> retry?
                                    (reduce-retry-fields fields)
                                    (reduce-sse-fields fields)))))))))
     next-buf]))</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_comments"><a class="anchor" href="#_comments"></a><a class="link" href="#_comments">Comments</a></h3>
<div class="paragraph">
<p>Third technique that helps with code readability is surprisingly "comments". Yeah I know that "Good code is its own documentation". Maybe this is not that good code ;). Anyway I have found useful:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Docstrings for public API</p>
<div class="ulist">
<ul>
<li>
<p>Obvious</p>
</li>
</ul>
</div>
</li>
<li>
<p>Docstrings for private functions</p>
<div class="ulist">
<ul>
<li>
<p>explaining reasons, why this function exists - this helps to understand the context</p>
</li>
<li>
<p>explaining not obvious implementation (why this function calls sync instead of async interface)</p>
</li>
<li>
<p>containing examples of passed parameters - saltstack response can be deep data structure and example of data in documentation helps to understand the body when destructuring is not possible</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">defn-</span> <span class="function">parse-print-job-minions-returns</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Example of minion print_job return:
  {:20200511183953191117
   {:Function test.ping,
    :Result {:minion1 {:return true, :retcode 0, :success true},
             :minion2 {:return true, :retcode 0, :success true}},
    :Target *,
    :Target-type glob,
    :Arguments [],
    :StartTime 2020, May 11 18:39:53.191117,
    :Minions [minion1 minion2],
    :User saltapi}}</span><span class="delimiter">&quot;</span></span>
  [return jid minions]
  (<span class="keyword">-&gt;&gt;</span> (<span class="symbol">:Result</span> (<span class="keyword">get</span> return (<span class="keyword">keyword</span> (<span class="keyword">str</span> jid))))
       (<span class="keyword">map</span> #(<span class="keyword">vector</span> (<span class="keyword">name</span> (<span class="keyword">first</span> %)) (<span class="keyword">second</span> %)))
       (<span class="keyword">filter</span> #(<span class="keyword">contains?</span> minions (<span class="keyword">first</span> %)))
       (<span class="keyword">map</span> #(<span class="keyword">assoc</span> {}
                    <span class="symbol">:minion</span> (<span class="keyword">first</span> %)
                    <span class="symbol">:return</span> (<span class="symbol">:return</span> (<span class="keyword">second</span> %))
                    <span class="symbol">:success</span> (<span class="symbol">:success</span> (<span class="keyword">second</span> %))))))</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_passing_data_down"><a class="anchor" href="#_passing_data_down"></a><a class="link" href="#_passing_data_down">Passing data down</a></h3>
<div class="paragraph">
<p>Well known technique from Clojure world is to pass one data structure to functions down the pipeline and every function pickups up only values it actually needs. It does not have to understand whole data structure.
clj-salt-api uses HTTP to communicate with salt-api and it uses <a href="https://github.com/ztellman/aleph">Aleph</a> library for this purpose. Aleph follows <a href="https://github.com/ring-clojure">Ring</a> spec and clj-salt-api request functions also accepts the same ring request map as a parameter. Passing data down has 2 advantages in this case:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>All HTTP related configuration is supported out-of-box (timeouts, proxy configuration, client certificates). Users can refer to official Aleph documentation.</p>
</li>
<li>
<p>All Salstack modules are supported out-of-box. Users can refer to official Salstack documentation and there is no need to map from official Salstack function and clj-salt-api function.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">defn</span> <span class="function">local-async-locate</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Locate files and limit results to 10 with local async client and locate module.</span><span class="delimiter">&quot;</span></span>
  []
  (<span class="keyword">let</span> [cl (example-client)]
    (print-and-close cl (salt/request-async
                         cl
                         {<span class="symbol">:form-params</span> {<span class="symbol">:client</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">local_async</span><span class="delimiter">&quot;</span></span>
                                        <span class="symbol">:tgt</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span>
                                        <span class="symbol">:fun</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">locate.locate</span><span class="delimiter">&quot;</span></span>
                                        <span class="symbol">:arg</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">ld.*</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>, <span class="integer">10</span>]
                                        <span class="symbol">:kwarg</span> {<span class="symbol">:count</span> <span class="predefined-constant">false</span>
                                                <span class="symbol">:regex</span> <span class="predefined-constant">true</span>}}}))))</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_testing"><a class="anchor" href="#_testing"></a><a class="link" href="#_testing">Testing</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Besides usual unit tests for pure functions (data in/data out), I had to figure out how to test async calls. Separating all async calls to one function and implement almost all code with simple functions (mentioned <a href="#async-code">here</a>) let me simplify testing.</p>
</div>
<div class="paragraph">
<p>It is important to mention that I have not applied TDD practices in clj-salt-api, because I have developed all code with REPL and added tests afterwards. I think the best granularity for testing asynchronous saltstack request is to test the flow. I have created macro <code>test-flow&#8594;</code> for that purpose (to simplify syntax).</p>
</div>
<div class="paragraph">
<p>Let&#8217;s take an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(testing <span class="string"><span class="delimiter">&quot;</span><span class="content">async minion job timeout</span><span class="delimiter">&quot;</span></span>
  (u/test-flow-&gt;
   (initial-op (java.util.UUID/randomUUID)) r
   (is (<span class="keyword">=</span> <span class="symbol">:connect</span> (<span class="symbol">:command</span> r))) (send-resp)
   (is (<span class="keyword">=</span> <span class="symbol">:request</span> (<span class="symbol">:command</span> r))) (connected-resp <span class="symbol">:all</span>)
   (is (<span class="keyword">=</span> <span class="symbol">:receive</span> (<span class="symbol">:command</span> r))) (minion-request-resp <span class="string"><span class="delimiter">&quot;</span><span class="content">job-1</span><span class="delimiter">&quot;</span></span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">minion1</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">minion2</span><span class="delimiter">&quot;</span></span>])
   (is (<span class="keyword">=</span> <span class="symbol">:find-job</span> (<span class="symbol">:command</span> r))) (timeout-resp)
   (is (send-minion-failure? r <span class="string"><span class="delimiter">&quot;</span><span class="content">minion1</span><span class="delimiter">&quot;</span></span>)) (find-job-resp [<span class="string"><span class="delimiter">&quot;</span><span class="content">minion1</span><span class="delimiter">&quot;</span></span>] [<span class="string"><span class="delimiter">&quot;</span><span class="content">minion2</span><span class="delimiter">&quot;</span></span>])
   (is (<span class="keyword">=</span> <span class="symbol">:receive</span> (<span class="symbol">:command</span> r))) (send-resp)
   (is (<span class="keyword">=</span> <span class="symbol">:send</span> (<span class="symbol">:command</span> r))) (minion-event-resp <span class="string"><span class="delimiter">&quot;</span><span class="content">job-1</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">minion2</span><span class="delimiter">&quot;</span></span>)
   (is (<span class="keyword">=</span> <span class="symbol">:unsubscribe</span> (<span class="symbol">:command</span> r))) (send-resp)
   (is (<span class="keyword">=</span> <span class="symbol">:exit</span> (<span class="symbol">:command</span> r))) (unsubscribe-resp)))</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Setup initial state (<code>op</code>)</p>
</li>
<li>
<p>Create send response as a response to initial command (async request sent a subscribe message to sse)</p>
</li>
<li>
<p>Assert that next command is <code>:connect</code> (async request is waiting for connected message from sse)</p>
</li>
<li>
<p>Create connected response with correlation-id <code>:all</code> as a response to <code>:connect</code> command</p>
</li>
<li>
<p>Assert that next command is <code>:request</code> (submitting job to saltstack)</p>
</li>
<li>
<p>Create response with job id <code>job-1</code> and expected minions <code>minion1</code> and <code>minion2</code> as a response to <code>:request</code> command</p>
</li>
<li>
<p>Assert that next command is <code>:receive</code> (async request is waiting for minion responses)</p>
</li>
<li>
<p>Create timeout response as a response to <code>:receive</code> (minions responses have not been delivered within specified timeout)</p>
</li>
<li>
<p>Assert that next command :find-job</p>
</li>
<li>
<p>&#8230;&#8203;</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>All handler functions could be tested separately, but to create current state (<code>op</code>) as a parameter to <code>handle-response</code> the tests need to understand internal structure. By testing flow, the test does not need internal representation of state, because the state is created with each test step. It verifies only the sequence of steps.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_future_work"><a class="anchor" href="#_future_work"></a><a class="link" href="#_future_work">Future work</a></h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Support for salt-ssh client</p>
</li>
<li>
<p>Support for scripting with babashka. It will be possible to create scripts similar to <a href="https://github.com/epiccastle/spire">Spire</a>, but with support for all saltstack modules</p>
</li>
<li>
<p>Integration tests with saltstack in docker container</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2020-05-26 21:18:36 +0200
</div>
</div>
<style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
pre.CodeRay{background:#f7f7f8}
.CodeRay .line-numbers{border-right:1px solid currentColor;opacity:.35;padding:0 .5em 0 0}
.CodeRay span.line-numbers{display:inline-block;margin-right:.75em}
.CodeRay .line-numbers strong{color:#000}
table.CodeRay{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.CodeRay td{vertical-align:top;line-height:inherit}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.code{padding:0 0 0 .75em}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
</body>
</html>